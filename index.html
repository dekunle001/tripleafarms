<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triple A Farms & Feeds Nigeria Ltd - Broiler Farm Management System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-green: #2d5016; --secondary-green: #4a7c23; --light-green: #7cb342;
            --accent-orange: #ff8c00; --dark-orange: #e65100; --bg-cream: #f5f5dc;
            --white: #ffffff; --gray-light: #f5f5f5; --gray-medium: #e0e0e0;
            --text-dark: #333333; --danger-red: #d32f2f; --success-green: #388e3c;
            --warning-amber: #f57c00;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-cream) 0%, #e8f5e9 100%);
            min-height: 100vh; color: var(--text-dark);
        }
        .login-container {
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            padding: 20px;
        }
        .login-box {
            background: var(--white); padding: 40px; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 450px; text-align: center;
        }
        .login-logo { width: 150px; height: auto; margin-bottom: 20px; }
        .login-box h1 { color: var(--primary-green); margin-bottom: 10px; font-size: 1.8rem; }
        .login-box h2 { color: var(--accent-orange); margin-bottom: 30px; font-size: 1.2rem; font-weight: 500; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--primary-green); font-weight: 600; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px 15px; border: 2px solid var(--gray-medium);
            border-radius: 10px; font-size: 16px; transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--secondary-green); box-shadow: 0 0 0 3px rgba(74, 124, 35, 0.1);
        }
        .btn {
            padding: 12px 30px; border: none; border-radius: 10px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: all 0.3s ease;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-orange) 0%, var(--dark-orange) 100%);
            color: var(--white); width: 100%;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(230, 81, 0, 0.4); }
        .btn-secondary { background: var(--gray-medium); color: var(--text-dark); }
        .btn-success { background: linear-gradient(135deg, var(--success-green) 0%, #2e7d32 100%); color: var(--white); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-red) 0%, #b71c1c 100%); color: var(--white); }
        .btn-sm { padding: 8px 16px; font-size: 14px; }
        .link-btn { background: none; border: none; color: var(--secondary-green); cursor: pointer; text-decoration: underline; font-size: 14px; }
        .app-container { display: none; min-height: 100vh; }
        .sidebar {
            position: fixed; left: 0; top: 0; width: 280px; height: 100vh;
            background: linear-gradient(180deg, var(--primary-green) 0%, #1b3d0f 100%);
            color: var(--white); overflow-y: auto; z-index: 1000; box-shadow: 4px 0 20px rgba(0,0,0,0.1);
        }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-logo { width: 80px; height: auto; margin-bottom: 10px; background: var(--white); border-radius: 10px; padding: 5px; }
        .sidebar-header h3 { font-size: 1rem; margin-bottom: 5px; }
        .user-info { font-size: 0.85rem; opacity: 0.8; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-top: 10px; }
        .nav-menu { padding: 20px 0; }
        .nav-item {
            padding: 15px 25px; cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; gap: 12px; border-left: 4px solid transparent;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); border-left-color: var(--accent-orange); }
        .nav-item.active { background: rgba(255,255,255,0.15); border-left-color: var(--accent-orange); }
        .main-content { margin-left: 280px; padding: 30px; min-height: 100vh; }
        .header {
            background: var(--white); padding: 20px 30px; border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { color: var(--primary-green); font-size: 1.8rem; }
        .header-actions { display: flex; gap: 10px; }
        .card {
            background: var(--white); border-radius: 15px; padding: 25px;
            margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--gray-light);
        }
        .card-title { color: var(--primary-green); font-size: 1.4rem; font-weight: 600; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: var(--white); border-radius: 15px; padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid var(--secondary-green);
            transition: transform 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card.orange { border-left-color: var(--accent-orange); }
        .stat-card.red { border-left-color: var(--danger-red); }
        .stat-card.blue { border-left-color: #1976d2; }
        .stat-label { color: #666; font-size: 0.9rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary-green); }
        .stat-value.currency { color: var(--accent-orange); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--gray-medium); }
        th {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            color: var(--white); font-weight: 600; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px;
        }
        tr:hover { background: var(--gray-light); }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .badge-success { background: #c8e6c9; color: #2e7d32; }
        .badge-warning { background: #ffe0b2; color: #e65100; }
        .badge-danger { background: #ffcdd2; color: #c62828; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-section { background: var(--gray-light); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .form-section h3 { color: var(--primary-green); margin-bottom: 15px; font-size: 1.1rem; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--white); border-radius: 20px; width: 100%; max-width: 700px;
            max-height: 90vh; overflow-y: auto; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            color: var(--white); padding: 20px 30px; border-radius: 20px 20px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h2 { font-size: 1.4rem; }
        .modal-close { background: none; border: none; color: var(--white); font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 30px; }
        .modal-footer { padding: 20px 30px; border-top: 1px solid var(--gray-medium); display: flex; justify-content: flex-end; gap: 10px; }
        .batch-selector {
            background: linear-gradient(135deg, var(--secondary-green) 0%, var(--primary-green) 100%);
            color: var(--white); padding: 20px; border-radius: 15px; margin-bottom: 25px;
        }
        .batch-selector h3 { margin-bottom: 15px; }
        .summary-section {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border-radius: 15px; padding: 25px; margin-bottom: 25px; border: 2px solid var(--accent-orange);
        }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .summary-item { text-align: center; padding: 15px; background: var(--white); border-radius: 10px; }
        .summary-label { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
        .summary-value { font-size: 1.5rem; font-weight: 700; color: var(--primary-green); }
        .summary-value.negative { color: var(--danger-red); }
        .summary-value.positive { color: var(--success-green); }
        .feed-super-starter { background: #e3f2fd; color: #1565c0; }
        .feed-starter { background: #f3e5f5; color: #7b1fa2; }
        .feed-finisher { background: #e8f5e9; color: #2e7d32; }
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .checkbox-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--secondary-green); }
        @media print { .sidebar, .header-actions, .btn { display: none !important; } .main-content { margin-left: 0; } }

        /* Compact Table Styles for More Information */
        .table-container table {
            font-size: 12px;
        }

        /* Extra compact for expenses page */
        #expensesPage .table-container table {
            font-size: 11px;
        }

        #expensesPage .table-container th,
        #expensesPage .table-container td {
            padding: 6px 8px;
        }

        .table-container th,
        .table-container td {
            padding: 8px 10px;
            line-height: 1.3;
        }

        .card .table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        /* Smaller badges */
        .badge {
            padding: 3px 8px;
            font-size: 11px;
        }

        /* Compact buttons in tables */
        table .btn-sm {
            padding: 4px 10px;
            font-size: 12px;
        }

        /* Reduce header sizes in cards */
        .card-title {
            font-size: 1.2rem;
        }

        /* Compact form sections */
        .form-section {
            padding: 15px;
        }

        /* Smaller summary items */
        .summary-item {
            padding: 10px;
        }

        .summary-value {
            font-size: 1.3rem;
        }

        .summary-label {
            font-size: 0.8rem;
        }
    </style>
<base target="_blank">
<base target="_blank">
</head>
<body>
    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <img src="logo.jpg" alt="Triple A Farms Logo" class="login-logo" onerror="this.onerror=null; this.style.display='none'; document.getElementById('loginLogoFallback').style.display='block'; console.log('Logo not found');">
            <div id="loginLogoFallback" style="font-size: 24px; font-weight: bold; color: var(--primary-green); margin-bottom: 10px; display: none;">üè¢ Triple A Farms</div>
            <h1>Triple A Farms & Feeds</h1>
            <h2>Nigeria Limited</h2>
            <div id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>PIN/Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter PIN">
                </div>
                <button class="btn btn-primary" onclick="login()">Login</button>
                <div style="margin-top: 15px;">
                    <button class="link-btn" onclick="showForgotPassword()">Forgot Password?</button>
                </div>
            </div>
            <div id="forgotPasswordForm" style="display: none;">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="resetEmail" placeholder="Enter your registered email">
                </div>
                <button class="btn btn-primary" onclick="resetPassword()">Send Reset Link</button>
                <div style="margin-top: 15px;">
                    <button class="link-btn" onclick="showLogin()">Back to Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container" id="appContainer">
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="logo.jpg" alt="Logo" class="sidebar-logo" onerror="this.onerror=null; this.style.display='none'; document.getElementById('sidebarLogoFallback').style.display='block'; console.log('Logo not found');">
                <div id="sidebarLogoFallback" style="font-size: 14px; font-weight: bold; margin-bottom: 5px; display: none;">üè¢ Triple A Farms</div>
                <h3>Triple A Farms</h3>
                <div class="user-info">
                    <div id="currentUserName">User</div>
                    <div id="currentUserRole" style="font-size: 0.75rem; opacity: 0.7;">Role</div>
                </div>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" onclick="showPage('dashboard')" data-page="dashboard" id="navDashboard"><span>üìä</span> Dashboard</div>
                <div class="nav-item" onclick="showPage('batches')" data-page="batches" id="navBatches"><span>üêî</span> Batches</div>
                <div class="nav-item" onclick="showPage('mortality')" data-page="mortality" id="navMortality"><span>üìã</span> Mortality Register</div>
                <div class="nav-item" onclick="showPage('feeds')" data-page="feeds" id="navFeeds"><span>üåæ</span> Feed Management</div>
                <div class="nav-item" onclick="showPage('sales')" data-page="sales" id="navSales"><span>üí∞</span> Sales</div>
                <div class="nav-item" onclick="showPage('expenses')" data-page="expenses" id="navExpenses"><span>üíµ</span> Expenses</div>
                <div class="nav-item" onclick="showPage('weeklyweight')" data-page="weeklyweight" id="navWeeklyWeight">
                    <span>‚öñÔ∏è</span> Weekly Weight
                </div>
                <div class="nav-item" onclick="showPage('salary')" data-page="salary" id="navSalary"><span>üë•</span> Salary</div>
                <div class="nav-item" onclick="showPage('reports')" data-page="reports" id="navReports"><span>üìà</span> Reports</div>
                <div class="nav-item" onclick="showPage('users')" data-page="users" id="navUsers" style="display: none;"><span>‚öôÔ∏è</span> User Management</div>
                <div class="nav-item" onclick="logout()"><span>üö™</span> Logout</div>
            </nav>
        </div>

        <div class="main-content">
            <!-- Dashboard Page -->
            <div class="page-section active" id="dashboardPage">
                <div class="header">
                    <h1>Dashboard</h1>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="exportToExcel('all')">üì• Export All Data</button>
                    </div>
                </div>
                <div class="batch-selector">
                    <h3>Select Active Batch</h3>
                    <select id="dashboardBatchSelect" onchange="changeBatch()" style="width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px;">
                        <option value="">-- Select a Batch --</option>
                    </select>
                </div>
                <div class="stats-grid" id="dashboardStats">
                    <div class="stat-card"><div class="stat-label">Total Birds in Stock</div><div class="stat-value" id="statTotalBirds">0</div></div>
                    <div class="stat-card orange"><div class="stat-label">Total Sales (‚Ç¶)</div><div class="stat-value currency" id="statTotalSales">‚Ç¶0.00</div></div>
                    <div class="stat-card red"><div class="stat-label">Total Expenses (‚Ç¶)</div><div class="stat-value currency" id="statTotalExpenses">‚Ç¶0.00</div></div>
                    <div class="stat-card blue"><div class="stat-label">Net Profit/Loss (‚Ç¶)</div><div class="stat-value currency" id="statNetProfit">‚Ç¶0.00</div></div>
                    <div class="stat-card"><div class="stat-label">Total Mortality</div><div class="stat-value" id="statMortality">0</div></div>
                    <div class="stat-card orange"><div class="stat-label">Feed Stock (Bags)</div><div class="stat-value" id="statFeedStock">0</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Recent Activity</span></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Date</th><th>Activity</th><th>Batch</th><th>User</th><th>Details</th></tr></thead>
                            <tbody id="recentActivityTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Batches Page -->
            <div class="page-section" id="batchesPage">
                <div class="header">
                    <h1>Batch Management</h1>
                    <div class="header-actions"><button class="btn btn-success" onclick="openBatchModal()">+ New Batch</button></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">All Batches</span></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Batch ID</th><th>Supplier</th><th>Start Date</th><th>Initial Birds</th><th>Current Birds</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="batchesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Mortality Page -->
            <div class="page-section" id="mortalityPage">
                <div class="header">
                    <h1>Daily Mortality Register</h1>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="openMortalityModal()">+ Add Record</button>
                        <button class="btn btn-secondary" onclick="exportMortalityReport()">üìÑ Export Report</button>
                    </div>
                </div>
                <div class="batch-selector">
                    <h3>Select Batch</h3>
                    <select id="mortalityBatchSelect" onchange="loadMortalityData()" style="width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px;">
                        <option value="">-- Select a Batch --</option>
                    </select>
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px;">
                            <input type="checkbox" id="showInactiveBatches" onchange="updateAllBatchSelects()" style="width: 18px; height: 18px;">
                            Show inactive batches
                        </label>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Mortality Records</span></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Date</th><th>Day Mortality</th><th>Evening Mortality</th><th>Total</th><th>Cause (if known)</th><th>Recorded By</th><th>Actions</th></tr></thead>
                            <tbody id="mortalityTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Feeds Page -->
            <div class="page-section" id="feedsPage">
                <div class="header">
                    <h1>Feed Management</h1>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="openFeedModal()">+ Add Feed Record</button>
                        <button class="btn btn-secondary" onclick="openFeedStockModal()">üì¶ Update Stock</button>
                    </div>
                </div>
                <div class="batch-selector">
                    <h3>Select Batch</h3>
                    <select id="feedBatchSelect" onchange="loadFeedData()" style="width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px;">
                        <option value="">-- Select a Batch --</option>
                    </select>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Super Starter Stock</div><div class="stat-value" id="stockSuperStarter">0 bags</div></div>
                    <div class="stat-card"><div class="stat-label">Starter Stock</div><div class="stat-value" id="stockStarter">0 bags</div></div>
                    <div class="stat-card"><div class="stat-label">Finisher Stock</div><div class="stat-value" id="stockFinisher">0 bags</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Daily Feed Consumption Records</span></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Date</th><th>Feed Type</th><th>Bags</th><th>Balance</th><th>Water (L)</th><th>Drugs Used</th><th>Recorded By</th><th>Actions</th></tr></thead>
                            <tbody id="feedsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sales Page -->
            <div class="page-section" id="salesPage">
                <div class="header">
                    <h1>Sales Management</h1>
                    <div class="header-actions"><button class="btn btn-success" onclick="openSalesModal()">+ New Sale</button></div>
                </div>
                <div class="batch-selector">
                    <h3>Select Batch</h3>
                    <select id="salesBatchSelect" onchange="loadSalesData()" style="width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px;">
                        <option value="">-- Select a Batch --</option>
                    </select>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Sales Records</span></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Date</th><th>Customer</th><th>Quantity (Birds)</th><th>Total Weight (kg)</th><th>Price/kg (‚Ç¶)</th><th>Total Amount (‚Ç¶)</th><th>Recorded By</th><th>Actions</th></tr></thead>
                            <tbody id="salesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expenses Page -->
            <div class="page-section" id="expensesPage">
                <div class="header">
                    <h1>Expenses</h1>
                    <div class="header-actions"><button class="btn btn-success" onclick="openExpenseModal()">+ Add Expense</button></div>
                </div>
                <div class="batch-selector">
                    <h3>Select Batch</h3>
                    <select id="expenseBatchSelect" onchange="loadExpenses()" style="width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px;">
                        <option value="">-- Select a Batch --</option>
                    </select>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Expense Records</span></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount (‚Ç¶)</th><th>Recorded By</th><th>Actions</th></tr></thead>
                            <tbody id="expensesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Salary Page -->
            <div class="page-section" id="salaryPage">
                <div class="header">
                    <h1>Salary Management</h1>
                    <div class="header-actions"><button class="btn btn-success" onclick="openSalaryModal()">+ Add Salary Record</button></div>
                </div>
                <div class="batch-selector">
                    <h3>Select Batch (Optional)</h3>
                    <select id="salaryBatchSelect" onchange="loadSalaries()" style="width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px;">
                        <option value="">-- All Batches / General Salary --</option>
                    </select>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Salary Records</span></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Date</th><th>Employee Name</th><th>Position</th><th>Batch</th><th>Month/Period</th><th>Amount (‚Ç¶)</th><th>Recorded By</th><th>Actions</th></tr></thead>
                            <tbody id="salaryTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            
            <!-- Weekly Weight Page -->
            <div class="page-section" id="weeklyweightPage">
                <div class="header">
                    <h1>Weekly Weight Records</h1>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="openWeeklyWeightModal()">+ Add Weight Record</button>
                    </div>
                </div>

                <div class="batch-selector">
                    <h3>Select Batch</h3>
                    <select id="weeklyWeightBatchSelect" onchange="loadWeeklyWeightData()" style="width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px;">
                        <option value="">-- Select a Batch --</option>
                    </select>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Weekly Weight Records & FCR Calculation</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Week</th>
                                    <th>Date</th>
                                    <th>Average Weight (kg)</th>
                                    <th>Total Feed Consumed (kg)</th>
                                    <th>Cumulative FCR</th>
                                    <th>Sample Size (Birds)</th>
                                    <th>Recorded By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="weeklyWeightTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div class="page-section" id="reportsPage">
                <div class="header">
                    <h1>Reports & Analytics</h1>
                    <div class="header-actions"><button class="btn btn-success" onclick="exportFullReport()">üìä Export Full Report</button></div>
                </div>
                <div class="batch-selector">
                    <h3>Select Batch for Detailed Report</h3>
                    <select id="reportBatchSelect" onchange="generateBatchReport()" style="width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px;">
                        <option value="">-- Select a Batch --</option>
                    </select>
                </div>
                <div class="summary-section" id="batchSummary" style="display: none;">
                    <h3 style="color: var(--primary-green); margin-bottom: 20px;">Batch Performance Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item"><div class="summary-label">Initial Birds</div><div class="summary-value" id="summaryInitialBirds">0</div></div>
                        <div class="summary-item"><div class="summary-label">Birds Sold</div><div class="summary-value" id="summaryBirdsSold">0</div></div>
                        <div class="summary-item"><div class="summary-label">Mortality</div><div class="summary-value negative" id="summaryMortality">0</div></div>
                        <div class="summary-item"><div class="summary-label">Current Stock</div><div class="summary-value" id="summaryCurrentStock">0</div></div>
                        <div class="summary-item"><div class="summary-label">Total Sales</div><div class="summary-value positive" id="summaryTotalSales">‚Ç¶0</div></div>
                        <div class="summary-item"><div class="summary-label">Total Expenses</div><div class="summary-value negative" id="summaryTotalExpenses">‚Ç¶0</div></div>
                        <div class="summary-item"><div class="summary-label">Net Profit/Loss</div><div class="summary-value" id="summaryNetProfit">‚Ç¶0</div></div>
                        <div class="summary-item"><div class="summary-label">FCR</div><div class="summary-value" id="summaryFCR">0.00</div></div>
                        <div class="summary-item"><div class="summary-label">Total Weight Sold</div><div class="summary-value" id="summaryTotalWeightSold">0 kg</div></div>
                        <div class="summary-item"><div class="summary-label">Avg Weight Sold</div><div class="summary-value" id="summaryAvgWeightSold">0 kg</div></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Income Statement</span></div>
                    <div class="table-container">
                        <table><thead><tr><th>Description</th><th>Amount (‚Ç¶)</th></tr></thead><tbody id="incomeStatementTable"></tbody></table>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Balance Sheet</span></div>
                    <div class="table-container">
                        <table><thead><tr><th>Assets</th><th>Amount (‚Ç¶)</th><th>Liabilities & Equity</th><th>Amount (‚Ç¶)</th></tr></thead><tbody id="balanceSheetTable"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- User Management Page -->
            <div class="page-section" id="usersPage">
                <div class="header">
                    <h1>User Management</h1>
                    <div class="header-actions"><button class="btn btn-success" onclick="openUserModal()">+ Create User</button></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">All Users</span></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Username</th><th>Email</th><th>Role</th><th>Permissions</th><th>Created</th><th>Actions</th></tr></thead>
                            <tbody id="usersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="batchModal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="batchModalTitle">New Batch</h2><button class="modal-close" onclick="closeModal('batchModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="batchId">
                <div class="form-row">
                    <div class="form-group"><label>Batch Name/ID *</label><input type="text" id="batchName" placeholder="e.g., BATCH-001"></div>
                    <div class="form-group"><label>Supplier Company *</label><input type="text" id="batchSupplier" placeholder="Supplier name"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Start Date *</label><input type="date" id="batchStartDate"></div>
                    <div class="form-group"><label>Initial Number of Birds *</label><input type="number" id="batchInitialBirds" placeholder="0"></div>
                </div>
                <div class="form-group"><label>Notes</label><input type="text" id="batchNotes" placeholder="Additional notes"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('batchModal')">Cancel</button><button class="btn btn-success" onclick="saveBatch()">Save Batch</button></div>
        </div>
    </div>

    <div class="modal" id="mortalityModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Add Mortality Record</h2><button class="modal-close" onclick="closeModal('mortalityModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="mortalityId">
                <div class="form-row">
                    <div class="form-group"><label>Date *</label><input type="date" id="mortalityDate"></div>
                    <div class="form-group"><label>Batch *</label><select id="mortalityBatch"><option value="">-- Select Batch --</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Day Mortality</label><input type="number" id="mortalityDay" placeholder="0" min="0"></div>
                    <div class="form-group"><label>Evening Mortality</label><input type="number" id="mortalityEvening" placeholder="0" min="0"></div>
                </div>
                <div class="form-group"><label>Cause (if known)</label><input type="text" id="mortalityCause" placeholder="e.g., Disease, Heat stress"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('mortalityModal')">Cancel</button><button class="btn btn-success" onclick="saveMortality()">Save Record</button></div>
        </div>
    </div>

    <div class="modal" id="feedModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Add Feed Consumption</h2><button class="modal-close" onclick="closeModal('feedModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="feedId">
                <div class="form-row">
                    <div class="form-group"><label>Date *</label><input type="date" id="feedDate"></div>
                    <div class="form-group"><label>Batch *</label><select id="feedBatch"><option value="">-- Select Batch --</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Feed Type *</label><select id="feedType"><option value="Super Starter">Super Starter</option><option value="Starter">Starter</option><option value="Finisher">Finisher</option></select></div>
                    <div class="form-group"><label>Bags Consumed *</label><input type="number" id="feedBagsConsumed" placeholder="0" step="0.5"></div>
                </div>
                <div class="form-group"><label>Water Usage (Liters)</label><input type="number" id="waterUsage" placeholder="0" step="0.1"></div>
                    <div class="form-group">
                        <label>Drugs/Medication Used in Water</label>
                        <input type="text" id="drugComments" placeholder="e.g., Antibiotics, Vitamins, Vaccines...">
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('feedModal')">Cancel</button><button class="btn btn-success" onclick="saveFeed()">Save Record</button></div>
        </div>
    </div>

    <div class="modal" id="feedStockModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Update Feed Stock</h2><button class="modal-close" onclick="closeModal('feedStockModal')">&times;</button></div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group"><label>Super Starter Stock (Bags)</label><input type="number" id="stockSuperStarterInput" placeholder="0"></div>
                    <div class="form-group"><label>Starter Stock (Bags)</label><input type="number" id="stockStarterInput" placeholder="0"></div>
                    <div class="form-group"><label>Finisher Stock (Bags)</label><input type="number" id="stockFinisherInput" placeholder="0"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('feedStockModal')">Cancel</button><button class="btn btn-success" onclick="saveFeedStock()">Update Stock</button></div>
        </div>
    </div>

    <div class="modal" id="salesModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Record Sale</h2><button class="modal-close" onclick="closeModal('salesModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="saleId">
                <div class="form-row">
                    <div class="form-group"><label>Date *</label><input type="date" id="saleDate"></div>
                    <div class="form-group"><label>Batch *</label><select id="saleBatch"><option value="">-- Select Batch --</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Customer Name</label><input type="text" id="saleCustomer" placeholder="Customer name"></div>
                    <div class="form-group"><label>Quantity (Birds) *</label><input type="number" id="saleQuantity" placeholder="0" onchange="calculateSaleTotal()"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Total Weight (kg) *</label><input type="number" id="saleWeight" placeholder="0" step="0.1" onchange="calculateSaleTotal()"></div>
                    <div class="form-group"><label>Price per kg (‚Ç¶) *</label><input type="number" id="salePricePerKg" placeholder="0" onchange="calculateSaleTotal()"></div>
                </div>
                <div class="form-group"><label>Total Amount (‚Ç¶)</label><input type="number" id="saleTotalAmount" placeholder="0" readonly style="background: var(--gray-light); font-weight: bold;"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('salesModal')">Cancel</button><button class="btn btn-success" onclick="saveSale()">Save Sale</button></div>
        </div>
    </div>

    <div class="modal" id="expenseModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Add Expense</h2><button class="modal-close" onclick="closeModal('expenseModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="expenseId">
                <div class="form-row">
                    <div class="form-group"><label>Date *</label><input type="date" id="expenseDate"></div>
                    <div class="form-group"><label>Category *</label><select id="expenseCategory">
                                <option value="Feed">Feed</option>
                                <option value="Medication">Medication</option>
                                <option value="Vaccination">Vaccination</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Equipment">Equipment</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Depreciation">Depreciation</option>
                                <option value="Fueling">Fueling</option>
                                <option value="Electricity">Electricity</option>
                                <option value="Charcoal">Charcoal</option>
                                <option value="Other">Other</option>
                            </select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Batch *</label><select id="expenseBatchModal"><option value="">-- Select Batch --</option></select></div>
                    <div class="form-group"><label>Amount (‚Ç¶) *</label><input type="number" id="expenseAmount" placeholder="0"></div>
                </div>
                <div class="form-group"><label>Description</label><input type="text" id="expenseDescription" placeholder="Expense details"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('expenseModal')">Cancel</button><button class="btn btn-success" onclick="saveExpense()">Save Expense</button></div>
        </div>
    </div>

    <div class="modal" id="salaryModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Add Salary Record</h2><button class="modal-close" onclick="closeModal('salaryModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="salaryId">
                <div class="form-row">
                    <div class="form-group"><label>Date *</label><input type="date" id="salaryDate"></div>
                    <div class="form-group"><label>Employee Name *</label><input type="text" id="salaryEmployee" placeholder="Full name"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Position</label><input type="text" id="salaryPosition" placeholder="e.g., Farm Manager"></div>
                    <div class="form-group"><label>Batch (Optional)</label><select id="salaryBatch"><option value="">-- Select Batch --</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Month *</label>
                        <select id="salaryMonth">
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Year *</label>
                        <select id="salaryYear">
                            <option value="2020">2020</option>
                            <option value="2021">2021</option>
                            <option value="2022">2022</option>
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                            <option value="2031">2031</option>
                            <option value="2032">2032</option>
                            <option value="2033">2033</option>
                            <option value="2034">2034</option>
                            <option value="2035">2035</option>
                            <option value="2036">2036</option>
                            <option value="2037">2037</option>
                            <option value="2038">2038</option>
                            <option value="2039">2039</option>
                            <option value="2040">2040</option>
                            <option value="2041">2041</option>
                            <option value="2042">2042</option>
                            <option value="2043">2043</option>
                            <option value="2044">2044</option>
                            <option value="2045">2045</option>
                            <option value="2046">2046</option>
                            <option value="2047">2047</option>
                            <option value="2048">2048</option>
                            <option value="2049">2049</option>
                            <option value="2050">2050</option>
                        </select>
                    </div>
                    <div class="form-group"></div>
                </div>
                <div class="form-group"><label>Amount (‚Ç¶) *</label><input type="number" id="salaryAmount" placeholder="0"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('salaryModal')">Cancel</button><button class="btn btn-success" onclick="saveSalary()">Save Record</button></div>
        </div>
    </div>

    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Create User</h2><button class="modal-close" onclick="closeModal('userModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="userId">
                <div class="form-row">
                    <div class="form-group"><label>Username *</label><input type="text" id="userUsername" placeholder="Username"></div>
                    <div class="form-group"><label>Email *</label><input type="email" id="userEmail" placeholder="email@example.com"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>PIN/Password *</label><input type="password" id="userPassword" placeholder="4-6 digit PIN"></div>
                    <div class="form-group"><label>Role</label><select id="userRole"><option value="staff">Staff</option><option value="manager">Manager</option></select></div>
                </div>
                <div class="form-section">
                    <h3>Page Permissions</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item"><input type="checkbox" id="permDashboard" checked><label for="permDashboard">Dashboard</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="permBatches"><label for="permBatches">Batches</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="permMortality"><label for="permMortality">Mortality</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="permFeeds"><label for="permFeeds">Feeds</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="permSales"><label for="permSales">Sales</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="permExpenses"><label for="permExpenses">Expenses</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="permSalary"><label for="permSalary">Salary</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="permWeeklyWeight"><label for="permWeeklyWeight">Weekly Weight</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="permReports"><label for="permReports">Reports</label></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button><button class="btn btn-success" onclick="saveUser()">Create User</button></div>
        </div>
    </div>

    
    <!-- Weekly Weight Modal -->
    <div class="modal" id="weeklyWeightModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Weekly Weight Record</h2>
                <button class="modal-close" onclick="closeModal('weeklyWeightModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="weeklyWeightId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="weeklyWeightDate">
                    </div>
                    <div class="form-group">
                        <label>Batch *</label>
                        <select id="weeklyWeightBatch">
                            <option value="">-- Select Batch --</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Week Number *</label>
                        <input type="number" id="weeklyWeightWeek" placeholder="e.g., 1, 2, 3..." min="1">
                    </div>
                    <div class="form-group">
                        <label>Average Weight (kg) *</label>
                        <input type="number" id="weeklyWeightAvg" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Sample Size (Birds Weighed) *</label>
                        <input type="number" id="weeklyWeightSample" placeholder="Number of birds sampled" min="1">
                    </div>
                    <div class="form-group">
                        <label>Total Feed Consumed This Week (kg)</label>
                        <input type="number" id="weeklyWeightFeed" placeholder="Auto-calculated from feed records" step="0.1" readonly style="background: var(--gray-light);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <input type="text" id="weeklyWeightNotes" placeholder="Any observations">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('weeklyWeightModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveWeeklyWeight()">Save Record</button>
            </div>
        </div>
    </div>

<div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header"><h2>Change Password</h2><button class="modal-close" onclick="closeModal('changePasswordModal')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Current Password</label><input type="password" id="currentPassword" placeholder="Enter current password"></div>
                <div class="form-group"><label>New Password</label><input type="password" id="newPassword" placeholder="Enter new password"></div>
                <div class="form-group"><label>Confirm New Password</label><input type="password" id="confirmPassword" placeholder="Confirm new password"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('changePasswordModal')">Cancel</button><button class="btn btn-success" onclick="changePassword()">Update Password</button></div>
        </div>
    </div>


    <script>
        // Data Storage
        let db = {
            users: [
                {
                    id: 1,
                    username: 'Admin',
                    email: 'admin@tripleafarms.com',
                    password: '1986',
                    role: 'admin',
                    permissions: ['dashboard', 'batches', 'mortality', 'feeds', 'sales', 'expenses', 'salary', 'reports', 'users'],
                    createdAt: new Date().toISOString()
                }
            ],
            batches: [],
            mortality: [],
            feeds: [],
            sales: [],
            expenses: [],
            salaries: [],
            feedStock: {
                'Super Starter': 0,
                'Starter': 0,
                'Finisher': 0
            },
            activityLog: [],
            weeklyWeights: []
        };

        let currentUser = null;
        let currentBatch = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromStorage();
            setDefaultDates();
        });

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('mortalityDate').value = today;
            document.getElementById('feedDate').value = today;
            document.getElementById('saleDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('salaryDate').value = today;
            document.getElementById('batchStartDate').value = today;
        }

        // Storage Management
        function saveDataToStorage() {
            localStorage.setItem('tripleAFarmsDB', JSON.stringify(db));
        }

        function loadDataFromStorage() {
            const stored = localStorage.getItem('tripleAFarmsDB');
            if (stored) {
                db = JSON.parse(stored);
                if (!db.users.find(u => u.username === 'Admin')) {
                    db.users.push({
                        id: 1,
                        username: 'Admin',
                        email: 'admin@tripleafarms.com',
                        password: '1986',
                        role: 'admin',
                        permissions: ['dashboard', 'batches', 'mortality', 'feeds', 'sales', 'expenses', 'salary', 'reports', 'users'],
                        createdAt: new Date().toISOString()
                    });
                }
            }
        }

        // Login Functions
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            const user = db.users.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('currentUserName').textContent = user.username;
                document.getElementById('currentUserRole').textContent = user.role === 'admin' ? 'Administrator' : user.role;

                setupUserPermissions();
                updateAllBatchSelects();
                loadDashboard();
                logActivity('Login', 'User logged in');
            } else {
                alert('Invalid username or password');
            }
        }

        function logout() {
            currentUser = null;
            currentBatch = null;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('forgotPasswordForm').style.display = 'none';
        }

        function resetPassword() {
            const email = document.getElementById('resetEmail').value.trim();
            if (!email) {
                alert('Please enter your email address');
                return;
            }

            const user = db.users.find(u => u.email === email);
            if (user) {
                alert('Password reset instructions have been sent to ' + email);
                showLogin();
            } else {
                alert('No account found with that email address');
            }
        }

        // Permission Management
        function setupUserPermissions() {
            if (currentUser.role === 'admin') {
                document.getElementById('navUsers').style.display = 'flex';
                return;
            }
            document.getElementById('navUsers').style.display = 'none';
            const pages = ['batches', 'mortality', 'feeds', 'sales', 'expenses', 'salary', 'weeklyweight', 'reports', 'monthlybalance'];
            pages.forEach(page => {
                const hasPermission = currentUser.permissions.includes(page);
                document.getElementById('nav' + page.charAt(0).toUpperCase() + page.slice(1)).style.display = hasPermission ? 'flex' : 'none';
            });
        }

        function hasPermission(page) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            if (page === 'dashboard') return true;
            return currentUser.permissions.includes(page);
        }

        // Navigation
        function showPage(page) {
            if (!hasPermission(page) && page !== 'dashboard') {
                alert('You do not have permission to access this page');
                return;
            }
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(page + 'Page').classList.add('active');
            document.querySelector('[data-page="' + page + '"]').classList.add('active');

            switch(page) {
                case 'dashboard': loadDashboard(); break;
                case 'batches': loadBatches(); break;
                case 'mortality': loadMortalityData(); break;
                case 'feeds': loadFeedData(); break;
                case 'sales': loadSalesData(); break;
                case 'expenses': loadExpenses(); break;
                case 'salary': loadSalaries(); break;
                case 'reports': loadReports(); break;
                case 'weeklyweight': loadWeeklyWeightData(); break;
                case 'monthlybalance': generateMonthlyBalanceSheet(); break;
                case 'users': if (currentUser.role === 'admin') loadUsers(); break;
            }
        }

        // Dashboard Functions
        function loadDashboard() {
            updateDashboardStats();
            loadRecentActivity();
            updateAllBatchSelects();
        }

        function updateDashboardStats() {
            const totalBirds = db.batches.reduce((sum, b) => sum + getCurrentBirds(b.id), 0);
            const totalSales = db.sales.reduce((sum, s) => sum + s.totalAmount, 0);
            const totalExpenses = db.expenses.reduce((sum, e) => sum + e.amount, 0) + db.salaries.reduce((sum, s) => sum + s.amount, 0);
            const totalMortality = db.mortality.reduce((sum, m) => sum + m.day + m.evening, 0);
            const totalFeedStock = db.feedStock['Super Starter'] + db.feedStock['Starter'] + db.feedStock['Finisher'];

            document.getElementById('statTotalBirds').textContent = totalBirds.toLocaleString();
            document.getElementById('statTotalSales').textContent = '‚Ç¶' + totalSales.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('statTotalExpenses').textContent = '‚Ç¶' + totalExpenses.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('statNetProfit').textContent = '‚Ç¶' + (totalSales - totalExpenses).toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('statMortality').textContent = totalMortality.toLocaleString();
            document.getElementById('statFeedStock').textContent = totalFeedStock.toLocaleString();
        }

        function loadRecentActivity() {
            const tbody = document.getElementById('recentActivityTable');
            const recent = db.activityLog.slice(-10).reverse();
            tbody.innerHTML = recent.map(activity => `
                <tr>
                    <td>${formatDate(activity.date)}</td>
                    <td>${activity.action}</td>
                    <td>${activity.batch || 'N/A'}</td>
                    <td>${activity.user}</td>
                    <td>${activity.details}</td>
                </tr>
            `).join('');
        }

        // Batch Functions
        function loadBatches() {
            const tbody = document.getElementById('batchesTable');
            tbody.innerHTML = db.batches.map(batch => {
                const currentBirds = getCurrentBirds(batch.id);
                return `
                    <tr>
                        <td>${batch.name}</td>
                        <td>${batch.supplier}</td>
                        <td>${formatDate(batch.startDate)}</td>
                        <td>${batch.initialBirds}</td>
                        <td>${currentBirds}</td>
                        <td><span class="badge ${batch.status === 'active' ? 'badge-success' : 'badge-warning'}">${batch.status}</span></td>
                        <td>
                            ${currentUser.role === 'admin' ? `
                                <button class="btn btn-sm btn-secondary" onclick="editBatch('${batch.id}')">Edit</button>
                                <button class="btn btn-sm ${batch.status === 'active' ? 'btn-warning' : 'btn-success'}" onclick="toggleBatchStatus('${batch.id}')">${batch.status === 'active' ? 'Deactivate' : 'Activate'}</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteBatch('${batch.id}')">Delete</button>
                            ` : '<span style="color: #999;">View Only</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getCurrentBirds(batchId) {
            const batch = db.batches.find(b => b.id === batchId);
            if (!batch) return 0;
            const mortality = db.mortality.filter(m => m.batchId === batchId).reduce((sum, m) => sum + m.day + m.evening, 0);
            const sold = db.sales.filter(s => s.batchId === batchId).reduce((sum, s) => sum + s.quantity, 0);
            return batch.initialBirds - mortality - sold;
        }

        function openBatchModal() {
            if (currentUser.role !== 'admin') {
                alert('Only admin can create batches');
                return;
            }
            document.getElementById('batchModalTitle').textContent = 'New Batch';
            document.getElementById('batchId').value = '';
            document.getElementById('batchName').value = '';
            document.getElementById('batchSupplier').value = '';
            document.getElementById('batchInitialBirds').value = '';
            document.getElementById('batchNotes').value = '';
            document.getElementById('batchModal').classList.add('active');
        }

        function editBatch(id) {
            const batch = db.batches.find(b => b.id === id);
            if (!batch) return;
            document.getElementById('batchModalTitle').textContent = 'Edit Batch';
            document.getElementById('batchId').value = batch.id;
            document.getElementById('batchName').value = batch.name;
            document.getElementById('batchSupplier').value = batch.supplier;
            document.getElementById('batchStartDate').value = batch.startDate;
            document.getElementById('batchInitialBirds').value = batch.initialBirds;
            document.getElementById('batchNotes').value = batch.notes || '';
            document.getElementById('batchModal').classList.add('active');
        }

        function saveBatch() {
            const id = document.getElementById('batchId').value;
            const name = document.getElementById('batchName').value.trim();
            const supplier = document.getElementById('batchSupplier').value.trim();
            const startDate = document.getElementById('batchStartDate').value;
            const initialBirds = parseInt(document.getElementById('batchInitialBirds').value) || 0;
            const notes = document.getElementById('batchNotes').value.trim();

            if (!name || !supplier || !startDate || !initialBirds) {
                alert('Please fill in all required fields');
                return;
            }

            if (id) {
                const batch = db.batches.find(b => b.id === id);
                batch.name = name;
                batch.supplier = supplier;
                batch.startDate = startDate;
                batch.initialBirds = initialBirds;
                batch.notes = notes;
                logActivity('Batch Updated', `Updated batch ${name}`, name);
            } else {
                const newBatch = {
                    id: 'BATCH-' + Date.now(),
                    name, supplier, startDate, initialBirds, notes,
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                db.batches.push(newBatch);
                logActivity('Batch Created', `Created new batch ${name}`, name);
            }
            saveDataToStorage();
            closeModal('batchModal');
            loadBatches();
            updateAllBatchSelects();
        }

        function deleteBatch(id) {
            if (!confirm('Are you sure you want to delete this batch?')) return;
            db.batches = db.batches.filter(b => b.id !== id);
            saveDataToStorage();
            loadBatches();
            updateAllBatchSelects();
        }

        function toggleBatchStatus(id) {
            const batch = db.batches.find(b => b.id === id);
            if (!batch) return;

            const newStatus = batch.status === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'activate' : 'deactivate';

            if (!confirm(`Are you sure you want to ${action} batch "${batch.name}"?`)) return;

            batch.status = newStatus;
            saveDataToStorage();
            loadBatches();
            updateAllBatchSelects();
            logActivity('Batch Status Changed', `Changed batch ${batch.name} status to ${newStatus}`, batch.name);
        }

        // Mortality Functions
        function loadMortalityData() {
            const batchId = document.getElementById('mortalityBatchSelect').value;
            const tbody = document.getElementById('mortalityTable');

            if (!batchId) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #666;">Please select a batch to view mortality records</td></tr>';
                return;
            }

            let records = db.mortality.filter(m => m.batchId === batchId);
            records.sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = records.map(m => {
                const canEdit = currentUser.role === 'admin' || m.createdBy === currentUser.username;
                return `
                    <tr>
                        <td>${formatDate(m.date)}</td>
                        <td>${m.day}</td>
                        <td>${m.evening}</td>
                        <td><strong>${m.day + m.evening}</strong></td>
                        <td>${m.cause || '-'}</td>
                        <td>${m.createdBy}</td>
                        <td>
                            ${canEdit ? `
                                <button class="btn btn-sm btn-secondary" onclick="editMortality('${m.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteMortality('${m.id}')">Delete</button>
                            ` : '<span style="color: #999;">View Only</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openMortalityModal() {
            document.getElementById('mortalityId').value = '';
            document.getElementById('mortalityDay').value = '';
            document.getElementById('mortalityEvening').value = '';
            document.getElementById('mortalityCause').value = '';
            updateBatchSelect('mortalityBatch');
            document.getElementById('mortalityModal').classList.add('active');
        }

        function editMortality(id) {
            const record = db.mortality.find(m => m.id === id);
            if (!record) return;
            document.getElementById('mortalityId').value = record.id;
            document.getElementById('mortalityDate').value = record.date;
            document.getElementById('mortalityBatch').value = record.batchId;
            document.getElementById('mortalityDay').value = record.day;
            document.getElementById('mortalityEvening').value = record.evening;
            document.getElementById('mortalityCause').value = record.cause || '';
            document.getElementById('mortalityModal').classList.add('active');
        }

        function saveMortality() {
            const id = document.getElementById('mortalityId').value;
            const date = document.getElementById('mortalityDate').value;
            const batchId = document.getElementById('mortalityBatch').value;
            const day = parseInt(document.getElementById('mortalityDay').value) || 0;
            const evening = parseInt(document.getElementById('mortalityEvening').value) || 0;
            const cause = document.getElementById('mortalityCause').value.trim();

            if (!date || !batchId) {
                alert('Please fill in required fields');
                return;
            }

            const batch = db.batches.find(b => b.id === batchId);

            if (id) {
                const record = db.mortality.find(m => m.id === id);
                record.date = date;
                record.batchId = batchId;
                record.day = day;
                record.evening = evening;
                record.cause = cause;
                logActivity('Mortality Updated', `Updated mortality record`, batch?.name);
            } else {
                const newRecord = {
                    id: 'MORT-' + Date.now(),
                    date, batchId, day, evening, cause,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                db.mortality.push(newRecord);
                logActivity('Mortality Added', `Added mortality: ${day + evening} birds`, batch?.name);
            }
            saveDataToStorage();
            closeModal('mortalityModal');
            loadMortalityData();
            updateDashboardStats();
        }

        function deleteMortality(id) {
            if (!confirm('Delete this record?')) return;
            db.mortality = db.mortality.filter(m => m.id !== id);
            saveDataToStorage();
            loadMortalityData();
            updateDashboardStats();
        }

        // Feed Functions
        function loadFeedData() {
            const batchId = document.getElementById('feedBatchSelect').value;
            document.getElementById('stockSuperStarter').textContent = db.feedStock['Super Starter'] + ' bags';
            document.getElementById('stockStarter').textContent = db.feedStock['Starter'] + ' bags';
            document.getElementById('stockFinisher').textContent = db.feedStock['Finisher'] + ' bags';

            const tbody = document.getElementById('feedsTable');

            if (!batchId) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #666;">Please select a batch to view feed records</td></tr>';
                return;
            }

            let records = db.feeds.filter(f => f.batchId === batchId);
            records.sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = records.map(f => {
                const canEdit = currentUser.role === 'admin' || f.createdBy === currentUser.username;
                const feedClass = f.type === 'Super Starter' ? 'feed-super-starter' : f.type === 'Starter' ? 'feed-starter' : 'feed-finisher';
                return `
                    <tr>
                        <td>${formatDate(f.date)}</td>
                        <td><span class="badge ${feedClass}">${f.type}</span></td>
                        <td>${f.bagsConsumed}</td>
                        <td>${f.balance}</td>
                        <td>${f.waterUsage || '-'}</td>
                        <td>${f.drugComments || '-'}</td>
                        <td>${f.createdBy}</td>
                        <td>
                            ${canEdit ? `
                                <button class="btn btn-sm btn-secondary" onclick="editFeed('${f.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteFeed('${f.id}')">Delete</button>
                            ` : '<span style="color: #999;">View Only</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openFeedModal() {
            document.getElementById('feedId').value = '';
            document.getElementById('feedBagsConsumed').value = '';
            document.getElementById('waterUsage').value = '';
            updateBatchSelect('feedBatch');
            document.getElementById('feedModal').classList.add('active');
        }

        function openFeedStockModal() {
            document.getElementById('stockSuperStarterInput').value = db.feedStock['Super Starter'];
            document.getElementById('stockStarterInput').value = db.feedStock['Starter'];
            document.getElementById('stockFinisherInput').value = db.feedStock['Finisher'];
            document.getElementById('feedStockModal').classList.add('active');
        }

        function saveFeed() {
            const id = document.getElementById('feedId').value;
            const date = document.getElementById('feedDate').value;
            const batchId = document.getElementById('feedBatch').value;
            const type = document.getElementById('feedType').value;
            const bagsConsumed = parseFloat(document.getElementById('feedBagsConsumed').value) || 0;
            const waterUsage = parseFloat(document.getElementById('waterUsage').value) || 0;
            const drugComments = document.getElementById('drugComments').value.trim();

            if (!date || !batchId || !bagsConsumed) {
                alert('Please fill in required fields');
                return;
            }

            if (db.feedStock[type] < bagsConsumed) {
                alert(`Insufficient ${type} stock. Available: ${db.feedStock[type]} bags`);
                return;
            }

            const batch = db.batches.find(b => b.id === batchId);

            if (id) {
                const record = db.feeds.find(f => f.id === id);
                db.feedStock[record.type] += record.bagsConsumed;
                db.feedStock[type] -= bagsConsumed;

                record.date = date;
                record.batchId = batchId;
                record.type = type;
                record.bagsConsumed = bagsConsumed;
                record.balance = db.feedStock[type];
                record.waterUsage = waterUsage;
                logActivity('Feed Updated', `Updated feed record`, batch?.name);
            } else {
                db.feedStock[type] -= bagsConsumed;
                const newRecord = {
                    id: 'FEED-' + Date.now(),
                    date, batchId, type, bagsConsumed,
                    balance: db.feedStock[type],
                    waterUsage,
                    drugComments,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                db.feeds.push(newRecord);
                logActivity('Feed Added', `Added feed consumption: ${bagsConsumed} bags of ${type}`, batch?.name);
            }
            saveDataToStorage();
            closeModal('feedModal');
            loadFeedData();
            updateDashboardStats();
        }

        function saveFeedStock() {
            db.feedStock['Super Starter'] = parseInt(document.getElementById('stockSuperStarterInput').value) || 0;
            db.feedStock['Starter'] = parseInt(document.getElementById('stockStarterInput').value) || 0;
            db.feedStock['Finisher'] = parseInt(document.getElementById('stockFinisherInput').value) || 0;
            saveDataToStorage();
            closeModal('feedStockModal');
            loadFeedData();
            updateDashboardStats();
            logActivity('Stock Updated', 'Updated feed stock levels');
        }

        function editFeed(id) {
            const record = db.feeds.find(f => f.id === id);
            if (!record) return;
            document.getElementById('feedId').value = record.id;
            document.getElementById('feedDate').value = record.date;
            document.getElementById('feedBatch').value = record.batchId;
            document.getElementById('feedType').value = record.type;
            document.getElementById('feedBagsConsumed').value = record.bagsConsumed;
            document.getElementById('waterUsage').value = record.waterUsage || '';
            document.getElementById('drugComments').value = record.drugComments || '';
            document.getElementById('feedModal').classList.add('active');
        }

        function deleteFeed(id) {
            if (!confirm('Delete this record?')) return;
            const record = db.feeds.find(f => f.id === id);
            if (record) db.feedStock[record.type] += record.bagsConsumed;
            db.feeds = db.feeds.filter(f => f.id !== id);
            saveDataToStorage();
            loadFeedData();
            updateDashboardStats();
        }

        // Sales Functions
        function loadSalesData() {
            const batchId = document.getElementById('salesBatchSelect').value;
            const tbody = document.getElementById('salesTable');

            if (!batchId) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #666;">Please select a batch to view sales records</td></tr>';
                return;
            }

            let records = db.sales.filter(s => s.batchId === batchId);
            records.sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = records.map(s => {
                const canEdit = currentUser.role === 'admin' || s.createdBy === currentUser.username;
                return `
                    <tr>
                        <td>${formatDate(s.date)}</td>
                        <td>${s.customer || '-'}</td>
                        <td>${s.quantity}</td>
                        <td>${s.weight}</td>
                        <td>‚Ç¶${s.pricePerKg.toLocaleString()}</td>
                        <td><strong>‚Ç¶${s.totalAmount.toLocaleString()}</strong></td>
                        <td>${s.createdBy}</td>
                        <td>
                            ${canEdit ? `
                                <button class="btn btn-sm btn-secondary" onclick="editSale('${s.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSale('${s.id}')">Delete</button>
                            ` : '<span style="color: #999;">View Only</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openSalesModal() {
            document.getElementById('saleId').value = '';
            document.getElementById('saleCustomer').value = '';
            document.getElementById('saleQuantity').value = '';
            document.getElementById('saleWeight').value = '';
            document.getElementById('salePricePerKg').value = '';
            document.getElementById('saleTotalAmount').value = '';
            updateBatchSelect('saleBatch');
            document.getElementById('salesModal').classList.add('active');
        }

        function calculateSaleTotal() {
            const weight = parseFloat(document.getElementById('saleWeight').value) || 0;
            const price = parseFloat(document.getElementById('salePricePerKg').value) || 0;
            document.getElementById('saleTotalAmount').value = (weight * price).toFixed(2);
        }

        function saveSale() {
            const id = document.getElementById('saleId').value;
            const date = document.getElementById('saleDate').value;
            const batchId = document.getElementById('saleBatch').value;
            const customer = document.getElementById('saleCustomer').value.trim();
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 0;
            const weight = parseFloat(document.getElementById('saleWeight').value) || 0;
            const pricePerKg = parseFloat(document.getElementById('salePricePerKg').value) || 0;
            const totalAmount = parseFloat(document.getElementById('saleTotalAmount').value) || 0;

            if (!date || !batchId || !quantity || !weight || !pricePerKg) {
                alert('Please fill in all required fields');
                return;
            }

            const batch = db.batches.find(b => b.id === batchId);
            const currentBirds = getCurrentBirds(batchId);

            if (!id && quantity > currentBirds) {
                alert(`Cannot sell more birds than available. Current stock: ${currentBirds}`);
                return;
            }

            if (id) {
                const sale = db.sales.find(s => s.id === id);
                sale.date = date;
                sale.batchId = batchId;
                sale.customer = customer;
                sale.quantity = quantity;
                sale.weight = weight;
                sale.pricePerKg = pricePerKg;
                sale.totalAmount = totalAmount;
                logActivity('Sale Updated', `Updated sale record`, batch?.name);
            } else {
                const newSale = {
                    id: 'SALE-' + Date.now(),
                    date, batchId, customer, quantity, weight, pricePerKg, totalAmount,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                db.sales.push(newSale);
                logActivity('Sale Recorded', `Sold ${quantity} birds`, batch?.name);
            }
            saveDataToStorage();
            closeModal('salesModal');
            loadSalesData();
            updateDashboardStats();
        }

        function editSale(id) {
            const sale = db.sales.find(s => s.id === id);
            if (!sale) return;
            document.getElementById('saleId').value = sale.id;
            document.getElementById('saleDate').value = sale.date;
            document.getElementById('saleBatch').value = sale.batchId;
            document.getElementById('saleCustomer').value = sale.customer || '';
            document.getElementById('saleQuantity').value = sale.quantity;
            document.getElementById('saleWeight').value = sale.weight;
            document.getElementById('salePricePerKg').value = sale.pricePerKg;
            document.getElementById('saleTotalAmount').value = sale.totalAmount;
            document.getElementById('salesModal').classList.add('active');
        }

        function deleteSale(id) {
            if (!confirm('Delete this sale record?')) return;
            db.sales = db.sales.filter(s => s.id !== id);
            saveDataToStorage();
            loadSalesData();
            updateDashboardStats();
        }

        // Expense Functions
        function loadExpenses() {
            updateBatchSelect('expenseBatchSelect');
            updateBatchSelect('expenseBatchModal');
            const batchId = document.getElementById('expenseBatchSelect').value;
            const tbody = document.getElementById('expensesTable');

            // If no batch selected, show empty table with message
            if (!batchId) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #666;">Please select a batch to view expense records</td></tr>';
                return;
            }

            let records = db.expenses.filter(e => e.batchId === batchId);
            records.sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = records.map(e => {
                const canEdit = currentUser.role === 'admin' || e.createdBy === currentUser.username;
                return `
                    <tr>
                        <td>${formatDate(e.date)}</td>
                        <td>${e.category}</td>
                        <td>${e.description || '-'}</td>
                        <td>‚Ç¶${e.amount.toLocaleString()}</td>
                        <td>${e.createdBy}</td>
                        <td>
                            ${canEdit ? `
                                <button class="btn btn-sm btn-secondary" onclick="editExpense('${e.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteExpense('${e.id}')">Delete</button>
                            ` : '<span style="color: #999;">View Only</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openExpenseModal() {
            document.getElementById('expenseId').value = '';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            updateBatchSelect('expenseBatchModal');
            document.getElementById('expenseModal').classList.add('active');
        }

        function saveExpense() {
            const id = document.getElementById('expenseId').value;
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const batchId = document.getElementById('expenseBatchModal').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const description = document.getElementById('expenseDescription').value.trim();

            if (!date || !category || !batchId || !amount) {
                alert('Please fill in required fields');
                return;
            }

            const batch = batchId ? db.batches.find(b => b.id === batchId) : null;

            if (id) {
                const expense = db.expenses.find(e => e.id === id);
                expense.date = date;
                expense.category = category;
                expense.batchId = batchId;
                expense.amount = amount;
                expense.description = description;
                logActivity('Expense Updated', `Updated ${category} expense`, batch?.name);
            } else {
                const newExpense = {
                    id: 'EXP-' + Date.now(),
                    date, category, batchId, amount, description,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                db.expenses.push(newExpense);
                logActivity('Expense Added', `Added ${category} expense: ‚Ç¶${amount}`, batch?.name);
            }
            saveDataToStorage();
            closeModal('expenseModal');
            loadExpenses();
            updateDashboardStats();
        }

        function editExpense(id) {
            const expense = db.expenses.find(e => e.id === id);
            if (!expense) return;
            document.getElementById('expenseId').value = expense.id;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseCategory').value = expense.category;
            document.getElementById('expenseBatchModal').value = expense.batchId || '';
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseDescription').value = expense.description || '';
            document.getElementById('expenseModal').classList.add('active');
        }

        function deleteExpense(id) {
            if (!confirm('Delete this expense?')) return;
            db.expenses = db.expenses.filter(e => e.id !== id);
            saveDataToStorage();
            loadExpenses();
            updateDashboardStats();
        }

        // Salary Functions
        function loadSalaries() {
            const batchId = document.getElementById('salaryBatchSelect').value;
            const tbody = document.getElementById('salaryTable');

            let records = db.salaries;
            if (batchId) {
                records = records.filter(s => s.batchId === batchId);
            }
            records.sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = records.map(s => {
                const canEdit = currentUser.role === 'admin' || s.createdBy === currentUser.username;
                const batch = db.batches.find(b => b.id === s.batchId);
                return `
                    <tr>
                        <td>${formatDate(s.date)}</td>
                        <td>${s.employee}</td>
                        <td>${s.position || '-'}</td>
                        <td>${batch ? batch.name : 'General'}</td>
                        <td>${s.period}</td>
                        <td>‚Ç¶${s.amount.toLocaleString()}</td>
                        <td>${s.createdBy}</td>
                        <td>
                            ${canEdit ? `
                                <button class="btn btn-sm btn-secondary" onclick="editSalary('${s.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSalary('${s.id}')">Delete</button>
                            ` : '<span style="color: #999;">View Only</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openSalaryModal() {
            document.getElementById('salaryId').value = '';
            document.getElementById('salaryEmployee').value = '';
            document.getElementById('salaryPosition').value = '';
            document.getElementById('salaryMonth').value = new Date().toLocaleString('default', { month: 'long' });
            document.getElementById('salaryYear').value = new Date().getFullYear();
            updateBatchSelect('salaryBatch');
            document.getElementById('salaryBatch').value = '';
            document.getElementById('salaryAmount').value = '';
            document.getElementById('salaryModal').classList.add('active');
        }

        function saveSalary() {
            const id = document.getElementById('salaryId').value;
            const date = document.getElementById('salaryDate').value;
            const employee = document.getElementById('salaryEmployee').value.trim();
            const position = document.getElementById('salaryPosition').value.trim();
            const month = document.getElementById('salaryMonth').value;
            const year = document.getElementById('salaryYear').value;
            const period = month + ' ' + year;
            const batchId = document.getElementById('salaryBatch').value;
            const amount = parseFloat(document.getElementById('salaryAmount').value) || 0;

            if (!date || !employee || !period || !amount) {
                alert('Please fill in required fields');
                return;
            }

            if (id) {
                const salary = db.salaries.find(s => s.id === id);
                salary.date = date;
                salary.employee = employee;
                salary.position = position;
                salary.period = period;
                salary.amount = amount;
                salary.batchId = batchId;
                logActivity('Salary Updated', `Updated salary for ${employee}`);
            } else {
                const newSalary = {
                    id: 'SAL-' + Date.now(),
                    date, employee, position, period, amount, batchId,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                db.salaries.push(newSalary);
                logActivity('Salary Added', `Added salary for ${employee}: ‚Ç¶${amount}`);
            }
            saveDataToStorage();
            closeModal('salaryModal');
            loadSalaries();
            updateDashboardStats();
        }

        function editSalary(id) {
            const salary = db.salaries.find(s => s.id === id);
            if (!salary) return;
            document.getElementById('salaryId').value = salary.id;
            document.getElementById('salaryDate').value = salary.date;
            document.getElementById('salaryEmployee').value = salary.employee;
            document.getElementById('salaryPosition').value = salary.position || '';
            const periodParts = salary.period.split(' ');
            if (periodParts.length === 2) {
                document.getElementById('salaryMonth').value = periodParts[0];
                document.getElementById('salaryYear').value = periodParts[1];
            }
            updateBatchSelect('salaryBatch');
            document.getElementById('salaryBatch').value = salary.batchId || '';
            document.getElementById('salaryAmount').value = salary.amount;
            document.getElementById('salaryModal').classList.add('active');
        }

        function deleteSalary(id) {
            if (!confirm('Delete this salary record?')) return;
            db.salaries = db.salaries.filter(s => s.id !== id);
            saveDataToStorage();
            loadSalaries();
            updateDashboardStats();
        }

        // Reports Functions
        function loadReports() {
            updateBatchSelect('reportBatchSelect');
        }

        function generateBatchReport() {
            const batchId = document.getElementById('reportBatchSelect').value;
            if (!batchId) {
                document.getElementById('batchSummary').style.display = 'none';
                return;
            }

            const batch = db.batches.find(b => b.id === batchId);
            if (!batch) return;

            const mortality = db.mortality.filter(m => m.batchId === batchId).reduce((sum, m) => sum + m.day + m.evening, 0);
            const sales = db.sales.filter(s => s.batchId === batchId);
            const birdsSold = sales.reduce((sum, s) => sum + s.quantity, 0);
            const totalSales = sales.reduce((sum, s) => sum + s.totalAmount, 0);
            const expenses = db.expenses.filter(e => e.batchId === batchId).reduce((sum, e) => sum + e.amount, 0);
            const salaryExpenses = db.salaries.filter(s => s.batchId === batchId).reduce((sum, s) => sum + s.amount, 0);
            const totalExpenses = expenses + salaryExpenses;
            const feedConsumed = db.feeds.filter(f => f.batchId === batchId).reduce((sum, f) => sum + f.bagsConsumed, 0);

            const currentStock = batch.initialBirds - mortality - birdsSold;
            const netProfit = totalSales - totalExpenses;
            const fcrData = calculateBatchFCR(batchId); const fcr = fcrData.fcr;

            // Calculate weight statistics
            const totalWeightSold = sales.reduce((sum, s) => sum + s.weight, 0);
            const avgWeightSold = birdsSold > 0 ? (totalWeightSold / birdsSold).toFixed(2) : '0.00';

            document.getElementById('summaryInitialBirds').textContent = batch.initialBirds;
            document.getElementById('summaryBirdsSold').textContent = birdsSold;
            document.getElementById('summaryMortality').textContent = mortality;
            document.getElementById('summaryCurrentStock').textContent = currentStock;
            document.getElementById('summaryTotalSales').textContent = '‚Ç¶' + totalSales.toLocaleString();
            document.getElementById('summaryTotalExpenses').textContent = '‚Ç¶' + totalExpenses.toLocaleString();
            document.getElementById('summaryNetProfit').textContent = '‚Ç¶' + netProfit.toLocaleString();
            document.getElementById('summaryNetProfit').className = 'summary-value ' + (netProfit >= 0 ? 'positive' : 'negative');
            document.getElementById('summaryFCR').textContent = fcr;
            document.getElementById('summaryTotalWeightSold').textContent = totalWeightSold + ' kg';
            document.getElementById('summaryAvgWeightSold').textContent = avgWeightSold + ' kg';
            document.getElementById('batchSummary').style.display = 'block';

            // Income Statement
            const incomeTbody = document.getElementById('incomeStatementTable');

            // Calculate expense breakdown
            const feedCosts = db.expenses.filter(e => e.batchId === batchId && e.category === 'Feed').reduce((s, e) => s + e.amount, 0);
            const medicationCosts = db.expenses.filter(e => e.batchId === batchId && e.category === 'Medication').reduce((s, e) => s + e.amount, 0);
            const depreciationCosts = db.expenses.filter(e => e.batchId === batchId && e.category === 'Depreciation').reduce((s, e) => s + e.amount, 0);
            const fuelingCosts = db.expenses.filter(e => e.batchId === batchId && e.category === 'Fueling').reduce((s, e) => s + e.amount, 0);
            const electricityCosts = db.expenses.filter(e => e.batchId === batchId && e.category === 'Electricity').reduce((s, e) => s + e.amount, 0);
            const charcoalCosts = db.expenses.filter(e => e.batchId === batchId && e.category === 'Charcoal').reduce((s, e) => s + e.amount, 0);
            const otherExpenseCosts = db.expenses.filter(e => e.batchId === batchId && !['Feed', 'Medication', 'Depreciation', 'Fueling', 'Electricity', 'Charcoal'].includes(e.category)).reduce((s, e) => s + e.amount, 0);

            // Calculate salary costs for this batch
            const salaryCosts = db.salaries.filter(s => s.batchId === batchId).reduce((sum, s) => sum + s.amount, 0);

            // Total expenses including salaries
            const totalExpensesWithSalaries = expenses + salaryCosts;
            const netProfitWithSalaries = totalSales - totalExpensesWithSalaries;

            incomeTbody.innerHTML = `
                <tr><td><strong>REVENUE</strong></td><td></td></tr>
                <tr><td style="padding-left: 30px;">Sales Revenue</td><td>‚Ç¶${totalSales.toLocaleString()}</td></tr>
                <tr style="background: #f5f5f5;"><td><strong>Total Revenue</strong></td><td><strong>‚Ç¶${totalSales.toLocaleString()}</strong></td></tr>
                <tr><td colspan="2"></td></tr>
                <tr><td><strong>EXPENSES</strong></td><td></td></tr>
                <tr><td style="padding-left: 30px;">Feed Costs</td><td>‚Ç¶${feedCosts.toLocaleString()}</td></tr>
                <tr><td style="padding-left: 30px;">Medication</td><td>‚Ç¶${medicationCosts.toLocaleString()}</td></tr>
                <tr><td style="padding-left: 30px;">Depreciation</td><td>‚Ç¶${depreciationCosts.toLocaleString()}</td></tr>
                <tr><td style="padding-left: 30px;">Fueling</td><td>‚Ç¶${fuelingCosts.toLocaleString()}</td></tr>
                <tr><td style="padding-left: 30px;">Electricity</td><td>‚Ç¶${electricityCosts.toLocaleString()}</td></tr>
                <tr><td style="padding-left: 30px;">Charcoal</td><td>‚Ç¶${charcoalCosts.toLocaleString()}</td></tr>
                <tr><td style="padding-left: 30px;">Other Expenses</td><td>‚Ç¶${otherExpenseCosts.toLocaleString()}</td></tr>
                <tr><td style="padding-left: 30px;">Salaries & Wages</td><td>‚Ç¶${salaryCosts.toLocaleString()}</td></tr>
                <tr style="background: #f5f5f5;"><td><strong>Total Expenses</strong></td><td><strong>‚Ç¶${totalExpensesWithSalaries.toLocaleString()}</strong></td></tr>
                <tr><td colspan="2"></td></tr>
                <tr style="background: ${netProfitWithSalaries >= 0 ? '#e8f5e9' : '#ffebee'};"><td><strong>Net ${netProfitWithSalaries >= 0 ? 'Profit' : 'Loss'}</strong></td><td><strong>‚Ç¶${Math.abs(netProfitWithSalaries).toLocaleString()}</strong></td></tr>
            `;

            // Balance Sheet
            const balanceTbody = document.getElementById('balanceSheetTable');
            const currentAssets = currentStock * (totalSales / (birdsSold || 1));
            balanceTbody.innerHTML = `
                <tr><td><strong>Current Assets</strong></td><td></td><td><strong>Liabilities</strong></td><td></td></tr>
                <tr><td style="padding-left: 30px;">Livestock (Birds)</td><td>‚Ç¶${currentAssets.toLocaleString()}</td><td style="padding-left: 30px;">Accounts Payable</td><td>‚Ç¶0</td></tr>
                <tr><td style="padding-left: 30px;">Feed Stock</td><td>‚Ç¶${((db.feedStock['Super Starter'] + db.feedStock['Starter'] + db.feedStock['Finisher']) * 15000).toLocaleString()}</td><td style="padding-left: 30px;">Other Liabilities</td><td>‚Ç¶0</td></tr>
                <tr style="background: #f5f5f5;"><td><strong>Total Assets</strong></td><td><strong>‚Ç¶${(currentAssets + (db.feedStock['Super Starter'] + db.feedStock['Starter'] + db.feedStock['Finisher']) * 15000).toLocaleString()}</strong></td><td><strong>Total Liabilities</strong></td><td><strong>‚Ç¶0</strong></td></tr>
                <tr><td></td><td></td><td><strong>Equity</strong></td><td></td></tr>
                <tr><td></td><td></td><td style="padding-left: 30px;">Retained Earnings</td><td>‚Ç¶${netProfit.toLocaleString()}</td></tr>
            `;
        }

        // User Management
        function loadUsers() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = db.users.map(u => `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.email}</td>
                    <td><span class="badge ${u.role === 'admin' ? 'badge-success' : 'badge-warning'}">${u.role}</span></td>
                    <td>${u.permissions.length} pages</td>
                    <td>${formatDate(u.createdAt)}</td>
                    <td>
                        ${u.role !== 'admin' ? `
                            <button class="btn btn-sm btn-secondary" onclick="editUser('${u.id}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')">Delete</button>
                        ` : '<span style="color: #999;">Protected</span>'}
                    </td>
                </tr>
            `).join('');
        }

        function openUserModal() {
            document.getElementById('userId').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = 'staff';
            document.querySelectorAll('#userModal input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('permDashboard').checked = true;
            document.getElementById('userModal').classList.add('active');
        }

        function saveUser() {
            const id = document.getElementById('userId').value;
            const username = document.getElementById('userUsername').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            if (!username || !email || (!id && !password)) {
                alert('Please fill in all required fields');
                return;
            }

            const permissions = [];
            document.querySelectorAll('#userModal input[type="checkbox"]:checked').forEach(cb => {
                let perm = cb.id.replace('perm', '').toLowerCase();
                if (perm === 'weeklyweight') perm = 'weeklyweight';
                permissions.push(perm);
            });

            if (id) {
                const user = db.users.find(u => u.id == id);
                user.username = username;
                user.email = email;
                if (password) user.password = password;
                user.role = role;
                user.permissions = permissions;
            } else {
                const newUser = {
                    id: Date.now(),
                    username, email, password, role, permissions,
                    createdAt: new Date().toISOString()
                };
                db.users.push(newUser);
            }
            saveDataToStorage();
            closeModal('userModal');
            loadUsers();
        }

        function editUser(id) {
            const user = db.users.find(u => u.id == id);
            if (!user) return;
            document.getElementById('userId').value = user.id;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = user.role;
            document.querySelectorAll('#userModal input[type="checkbox"]').forEach(cb => {
                let perm = cb.id.replace('perm', '').toLowerCase();
                if (perm === 'weeklyweight') perm = 'weeklyweight';
                cb.checked = user.permissions.includes(perm);
            });
            document.getElementById('userModal').classList.add('active');
        }

        function deleteUser(id) {
            if (!confirm('Delete this user?')) return;
            db.users = db.users.filter(u => u.id != id);
            saveDataToStorage();
            loadUsers();
        }

        function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            if (current !== currentUser.password) {
                alert('Current password is incorrect');
                return;
            }
            if (newPass !== confirm) {
                alert('New passwords do not match');
                return;
            }
            if (newPass.length < 4) {
                alert('Password must be at least 4 characters');
                return;
            }
            currentUser.password = newPass;
            saveDataToStorage();
            closeModal('changePasswordModal');
            alert('Password changed successfully');
        }

        // Helper Functions
        function updateAllBatchSelects() {
            ['dashboardBatchSelect', 'mortalityBatchSelect', 'feedBatchSelect', 'salesBatchSelect', 'expenseBatchSelect', 'weeklyWeightBatchSelect', 'reportBatchSelect'].forEach(id => {
                updateBatchSelect(id);
            });
        }

        function updateBatchSelect(selectId) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            const showInactive = document.getElementById('showInactiveBatches')?.checked || false;

            select.innerHTML = '<option value="">-- Select a Batch --</option>' + 
                db.batches.filter(b => showInactive || b.status === 'active').map(b => {
                    const statusIndicator = b.status === 'inactive' ? ' [INACTIVE]' : '';
                    return `<option value="${b.id}">${b.name}${statusIndicator} (${getCurrentBirds(b.id)} birds)</option>`;
                }).join('');
            select.value = currentValue;
        }

        function changeBatch() {
            currentBatch = document.getElementById('dashboardBatchSelect').value;
            updateDashboardStats();
        }

        function logActivity(action, details, batchName = null) {
            db.activityLog.push({
                date: new Date().toISOString(),
                action, details, batch: batchName,
                user: currentUser.username
            });
            saveDataToStorage();
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-NG', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Export Functions
        function exportToExcel(type) {
            let csv = '';
            let filename = '';

            switch(type) {
                case 'mortality':
                    csv = convertToCSV(db.mortality, ['date', 'batchId', 'day', 'evening', 'cause', 'createdBy']);
                    filename = 'mortality_report.csv';
                    break;
                case 'sales':
                    csv = convertToCSV(db.sales, ['date', 'batchId', 'customer', 'quantity', 'weight', 'pricePerKg', 'totalAmount', 'createdBy']);
                    filename = 'sales_report.csv';
                    break;
                case 'all':
                    csv = generateFullReportCSV();
                    filename = 'triple_a_farms_full_report.csv';
                    break;
                default:
                    csv = generateFullReportCSV();
                    filename = 'triple_a_farms_report.csv';
            }
            downloadCSV(csv, filename);
        }

        function convertToCSV(data, headers) {
            if (data.length === 0) return '';
            let csv = headers.join(',') + '\n';
            data.forEach(row => {
                csv += headers.map(h => {
                    let val = row[h];
                    if (h === 'batchId') {
                        const batch = db.batches.find(b => b.id === val);
                        val = batch ? batch.name : val;
                    }
                    return '"' + (val || '') + '"';
                }).join(',') + '\n';
            });
            return csv;
        }

        function generateFullReportCSV() {
            let csv = 'TRIPLE A FARMS & FEEDS NIGERIA LTD - COMPREHENSIVE REPORT\n';
            csv += 'Generated on: ' + new Date().toLocaleString() + '\n\n';

            csv += 'BATCHES\n';
            csv += 'ID,Name,Supplier,Start Date,Initial Birds,Current Birds,Status\n';
            db.batches.forEach(b => {
                csv += `"${b.id}","${b.name}","${b.supplier}","${b.startDate}",${b.initialBirds},${getCurrentBirds(b.id)},"${b.status}"\n`;
            });

            csv += '\nMORTALITY RECORDS\n';
            csv += 'Date,Batch,Day,Evening,Total,Cause,Recorded By\n';
            db.mortality.forEach(m => {
                const batch = db.batches.find(b => b.id === m.batchId);
                csv += `"${m.date}","${batch ? batch.name : m.batchId}",${m.day},${m.evening},${m.day + m.evening},"${m.cause || ''}","${m.createdBy}"\n`;
            });

            csv += '\nSALES RECORDS\n';
            csv += 'Date,Batch,Customer,Quantity,Weight(kg),Price/kg,Total Amount,Recorded By\n';
            db.sales.forEach(s => {
                const batch = db.batches.find(b => b.id === s.batchId);
                csv += `"${s.date}","${batch ? batch.name : s.batchId}","${s.customer || ''}",${s.quantity},${s.weight},${s.pricePerKg},${s.totalAmount},"${s.createdBy}"\n`;
            });

            csv += '\nEXPENSES\n';
            csv += 'Date,Category,Batch,Description,Amount,Recorded By\n';
            db.expenses.forEach(e => {
                const batch = db.batches.find(b => b.id === e.batchId);
                csv += `"${e.date}","${e.category}","${batch ? batch.name : 'General'}","${e.description || ''}",${e.amount},"${e.createdBy}"\n`;
            });

            csv += '\nSALARIES\n';
            csv += 'Date,Employee,Position,Period,Amount,Recorded By\n';
            db.salaries.forEach(s => {
                csv += `"${s.date}","${s.employee}","${s.position || ''}","${s.period}",${s.amount},"${s.createdBy}"\n`;
            });

            csv += '\nFEED CONSUMPTION\n';
            csv += 'Date,Batch,Type,Bags Consumed,Balance,Water Usage,Recorded By\n';
            db.feeds.forEach(f => {
                const batch = db.batches.find(b => b.id === f.batchId);
                csv += `"${f.date}","${batch ? batch.name : f.batchId}","${f.type}",${f.bagsConsumed},${f.balance},${f.waterUsage || 0},"${f.createdBy}"\n`;
            });

            return csv;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function exportMortalityReport() {
            exportToExcel('mortality');
        }

        function exportFullReport() {
            exportToExcel('all');
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Weekly Weight Functions
        function loadWeeklyWeightData() {
            const batchId = document.getElementById('weeklyWeightBatchSelect').value;
            const tbody = document.getElementById('weeklyWeightTable');

            if (!batchId) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #666;">Please select a batch to view weekly weight records</td></tr>';
                return;
            }

            let records = (db.weeklyWeights || []).filter(w => w.batchId === batchId);

            // Sort by week number
            records.sort((a, b) => a.week - b.week);

            // Calculate cumulative FCR for each record
            records = records.map((record, index) => {
                const cumulativeFeed = records.slice(0, index + 1).reduce((sum, r) => sum + r.feedConsumed, 0);
                const cumulativeWeight = record.avgWeight * getCurrentBirds(record.batchId);
                const fcr = cumulativeWeight > 0 ? (cumulativeFeed / cumulativeWeight).toFixed(2) : '0.00';
                return { ...record, cumulativeFCR: fcr, cumulativeFeed };
            });

            tbody.innerHTML = records.map(w => {
                const canEdit = currentUser.role === 'admin' || w.createdBy === currentUser.username;
                return `
                    <tr>
                        <td><strong>Week ${w.week}</strong></td>
                        <td>${formatDate(w.date)}</td>
                        <td>${w.avgWeight} kg</td>
                        <td>${w.feedConsumed} kg</td>
                        <td><span class="badge ${parseFloat(w.cumulativeFCR) <= 2.0 ? 'badge-success' : parseFloat(w.cumulativeFCR) <= 2.5 ? 'badge-warning' : 'badge-danger'}">${w.cumulativeFCR}</span></td>
                        <td>${w.sampleSize} birds</td>
                        <td>${w.createdBy}</td>
                        <td>
                            ${canEdit ? `
                                <button class="btn btn-sm btn-secondary" onclick="editWeeklyWeight('${w.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteWeeklyWeight('${w.id}')">Delete</button>
                            ` : '<span style="color: #999;">View Only</span>'}
                        </td>
                    </tr>
                `;
            }).join('');

            // Update chart
            updateFCRChart(records);
        }

        function openWeeklyWeightModal() {
            console.log('Opening weekly weight modal...');
            document.getElementById('weeklyWeightId').value = '';
            document.getElementById('weeklyWeightDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('weeklyWeightWeek').value = '';
            document.getElementById('weeklyWeightAvg').value = '';
            document.getElementById('weeklyWeightSample').value = '';
            document.getElementById('weeklyWeightFeed').value = '';
            document.getElementById('weeklyWeightNotes').value = '';
            updateBatchSelect('weeklyWeightBatch');
            document.getElementById('weeklyWeightBatch').value = '';
            const modal = document.getElementById('weeklyWeightModal');
            if (modal) {
                modal.classList.add('active');
                console.log('Modal opened successfully');
            } else {
                console.error('Weekly Weight modal not found!');
                alert('Error: Could not open modal. Please refresh the page.');
            }
        }

        function calculateWeeklyFeed(batchId, weekStartDate, weekEndDate) {
            // Calculate total feed consumed in the date range
            const weekFeeds = db.feeds.filter(f => {
                return f.batchId === batchId && 
                       f.date >= weekStartDate && 
                       f.date <= weekEndDate;
            });
            // Each bag is 25kg
            return weekFeeds.reduce((sum, f) => sum + (f.bagsConsumed * 25), 0);
        }

        function saveWeeklyWeight() {
            const id = document.getElementById('weeklyWeightId').value;
            const date = document.getElementById('weeklyWeightDate').value;
            const batchId = document.getElementById('weeklyWeightBatch').value;
            const week = parseInt(document.getElementById('weeklyWeightWeek').value) || 0;
            const avgWeight = parseFloat(document.getElementById('weeklyWeightAvg').value) || 0;
            const sampleSize = parseInt(document.getElementById('weeklyWeightSample').value) || 0;
            const notes = document.getElementById('weeklyWeightNotes').value.trim();

            if (!date || !batchId || !week || !avgWeight || !sampleSize) {
                alert('Please fill in all required fields');
                return;
            }

            // Calculate feed consumed for this week
            const weekStart = new Date(date);
            weekStart.setDate(weekStart.getDate() - 6); // Week ending on the date selected
            const feedConsumed = calculateWeeklyFeed(batchId, weekStart.toISOString().split('T')[0], date);

            const batch = db.batches.find(b => b.id === batchId);

            if (!db.weeklyWeights) db.weeklyWeights = [];

            if (id) {
                const record = db.weeklyWeights.find(w => w.id === id);
                record.date = date;
                record.batchId = batchId;
                record.week = week;
                record.avgWeight = avgWeight;
                record.sampleSize = sampleSize;
                record.feedConsumed = feedConsumed;
                record.notes = notes;
                logActivity('Weight Updated', `Updated week ${week} weight record`, batch?.name);
            } else {
                const newRecord = {
                    id: 'WW-' + Date.now(),
                    date, batchId, week, avgWeight, sampleSize,
                    feedConsumed,
                    notes,
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };
                db.weeklyWeights.push(newRecord);
                logActivity('Weight Added', `Added week ${week} weight: ${avgWeight}kg avg`, batch?.name);
            }

            saveDataToStorage();
            closeModal('weeklyWeightModal');
            loadWeeklyWeightData();
        }

        function editWeeklyWeight(id) {
            const record = db.weeklyWeights.find(w => w.id === id);
            if (!record) return;

            document.getElementById('weeklyWeightId').value = record.id;
            document.getElementById('weeklyWeightDate').value = record.date;
            document.getElementById('weeklyWeightBatch').value = record.batchId;
            document.getElementById('weeklyWeightWeek').value = record.week;
            document.getElementById('weeklyWeightAvg').value = record.avgWeight;
            document.getElementById('weeklyWeightSample').value = record.sampleSize;
            document.getElementById('weeklyWeightFeed').value = record.feedConsumed;
            document.getElementById('weeklyWeightNotes').value = record.notes || '';
            document.getElementById('weeklyWeightModal').classList.add('active');
        }

        function deleteWeeklyWeight(id) {
            if (!confirm('Delete this weight record?')) return;
            db.weeklyWeights = db.weeklyWeights.filter(w => w.id !== id);
            saveDataToStorage();
            loadWeeklyWeightData();
        }

        function updateFCRChart(records) {
            const canvas = document.getElementById('fcrChart');
            if (!canvas || records.length === 0) return;

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw simple chart
            const padding = 60;
            const chartWidth = canvas.width - (padding * 2);
            const chartHeight = canvas.height - (padding * 2);

            // Find max values
            const maxFCR = Math.max(...records.map(r => parseFloat(r.cumulativeFCR)), 3);
            const maxWeek = Math.max(...records.map(r => r.week));

            // Draw axes
            ctx.beginPath();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();

            // Draw FCR line
            ctx.beginPath();
            ctx.strokeStyle = '#4a7c23';
            ctx.lineWidth = 3;

            records.forEach((record, index) => {
                const x = padding + (record.week / maxWeek) * chartWidth;
                const y = (canvas.height - padding) - (parseFloat(record.cumulativeFCR) / maxFCR) * chartHeight;

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                // Draw point
                ctx.fillStyle = '#ff8c00';
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fill();

                // Draw label
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`W${record.week}`, x, canvas.height - padding + 20);
                ctx.fillText(record.cumulativeFCR, x, y - 10);
            });
            ctx.stroke();

            // Draw title
            ctx.fillStyle = '#2d5016';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('FCR Trend Over Weeks', canvas.width / 2, 30);

            // Draw Y-axis label
            ctx.save();
            ctx.translate(20, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Cumulative FCR', 0, 0);
            ctx.restore();
        }

        // Enhanced FCR Calculation for Reports
        function calculateBatchFCR(batchId) {
            const batch = db.batches.find(b => b.id === batchId);
            if (!batch) return { fcr: 0, totalFeed: 0, totalWeight: 0 };

            const sales = db.sales.filter(s => s.batchId === batchId);
            const totalWeight = sales.reduce((sum, s) => sum + s.weight, 0);
            const totalFeed = db.feeds.filter(f => f.batchId === batchId).reduce((sum, f) => sum + (f.bagsConsumed * 25), 0);

            const fcr = totalWeight > 0 ? (totalFeed / totalWeight).toFixed(2) : '0.00';
            return { fcr, totalFeed, totalWeight };
        }


        // Monthly Balance Sheet Functions
        function generateMonthlyBalanceSheet() {
            const month = document.getElementById('balanceMonth').value;
            const year = document.getElementById('balanceYear').value;

            if (!month || !year) {
                document.getElementById('monthlySummary').style.display = 'none';
                return;
            }

            const monthStart = `${year}-${month}-01`;
            const monthEnd = new Date(year, month, 0).toISOString().split('T')[0];

            const monthlySales = db.sales.filter(s => s.date >= monthStart && s.date <= monthEnd);
            const monthlyExpenses = db.expenses.filter(e => e.date >= monthStart && e.date <= monthEnd);
            const monthlySalaries = db.salaries.filter(s => s.date >= monthStart && s.date <= monthEnd);
            const monthlyFeeds = db.feeds.filter(f => f.date >= monthStart && f.date <= monthEnd);

            const totalRevenue = monthlySales.reduce((sum, s) => sum + s.totalAmount, 0);
            const totalExpenses = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalSalaries = monthlySalaries.reduce((sum, s) => sum + s.amount, 0);
            const totalFeedCost = monthlyFeeds.reduce((sum, f) => sum + f.bagsConsumed, 0) * 15000;
            const totalOperating = totalExpenses + totalSalaries + totalFeedCost;
            const grossProfit = totalRevenue - totalOperating;

            document.getElementById('monthlyRevenue').textContent = '‚Ç¶' + totalRevenue.toLocaleString();
            document.getElementById('monthlyExpenses').textContent = '‚Ç¶' + totalExpenses.toLocaleString();
            document.getElementById('monthlySalaries').textContent = '‚Ç¶' + totalSalaries.toLocaleString();
            document.getElementById('monthlyFeedCosts').textContent = '‚Ç¶' + totalFeedCost.toLocaleString();
            document.getElementById('monthlyGrossProfit').textContent = '‚Ç¶' + grossProfit.toLocaleString();
            document.getElementById('monthlyGrossProfit').className = 'summary-value ' + (grossProfit >= 0 ? 'positive' : 'negative');
            document.getElementById('monthlyNetProfit').textContent = '‚Ç¶' + grossProfit.toLocaleString();
            document.getElementById('monthlyNetProfit').className = 'summary-value ' + (grossProfit >= 0 ? 'positive' : 'negative');

            document.getElementById('monthlySummary').style.display = 'block';

            generateMonthlyIncomeStatement(totalRevenue, totalExpenses, totalSalaries, totalFeedCost, grossProfit);
            generateMonthlyBalanceSheetTable(grossProfit);
            generateMonthlyExpenseBreakdown(monthlyExpenses, totalOperating);
            generateMonthlyFeedAnalysis(monthlyFeeds, totalFeedCost);
            generateMonthlySalesSummary(monthlySales);
        }

        function generateMonthlyIncomeStatement(revenue, expenses, salaries, feedCost, grossProfit) {
            const tbody = document.getElementById('monthlyIncomeStatementBody');
            const totalOperating = expenses + salaries + feedCost;

            // Get month and year from the selected values
            const month = document.getElementById('balanceMonth').value;
            const year = document.getElementById('balanceYear').value;
            const monthStart = `${year}-${month}-01`;
            const monthEnd = new Date(year, month, 0).toISOString().split('T')[0];

            // Get monthly expenses breakdown
            const monthlyExpenses = db.expenses.filter(e => e.date >= monthStart && e.date <= monthEnd);
            const monthlyDepreciation = monthlyExpenses.filter(e => e.category === 'Depreciation').reduce((s, e) => s + e.amount, 0);
            const monthlyFueling = monthlyExpenses.filter(e => e.category === 'Fueling').reduce((s, e) => s + e.amount, 0);
            const monthlyElectricity = monthlyExpenses.filter(e => e.category === 'Electricity').reduce((s, e) => s + e.amount, 0);
            const monthlyCharcoal = monthlyExpenses.filter(e => e.category === 'Charcoal').reduce((s, e) => s + e.amount, 0);
            const monthlyMedication = monthlyExpenses.filter(e => e.category === 'Medication').reduce((s, e) => s + e.amount, 0);
            const monthlyOther = monthlyExpenses.filter(e => !['Feed', 'Medication', 'Depreciation', 'Fueling', 'Electricity', 'Charcoal'].includes(e.category)).reduce((s, e) => s + e.amount, 0);

            tbody.innerHTML = `
                <tr style="background: #e8f5e9;"><td><strong>REVENUE</strong></td><td></td><td></td></tr>
                <tr><td style="padding-left: 30px;">Sales Revenue</td><td>‚Ç¶${revenue.toLocaleString()}</td><td>100%</td></tr>
                <tr style="background: #f5f5f5;"><td><strong>Total Revenue</strong></td><td><strong>‚Ç¶${revenue.toLocaleString()}</strong></td><td><strong>100%</strong></td></tr>
                <tr><td colspan="3"></td></tr>
                <tr style="background: #ffebee;"><td><strong>OPERATING EXPENSES</strong></td><td></td><td></td></tr>
                <tr><td style="padding-left: 30px;">Feed Costs</td><td>‚Ç¶${feedCost.toLocaleString()}</td><td>${revenue > 0 ? ((feedCost/revenue)*100).toFixed(1) : 0}%</td></tr>
                <tr><td style="padding-left: 30px;">Medication</td><td>‚Ç¶${monthlyMedication.toLocaleString()}</td><td>${revenue > 0 ? ((monthlyMedication/revenue)*100).toFixed(1) : 0}%</td></tr>
                <tr><td style="padding-left: 30px;">Depreciation</td><td>‚Ç¶${monthlyDepreciation.toLocaleString()}</td><td>${revenue > 0 ? ((monthlyDepreciation/revenue)*100).toFixed(1) : 0}%</td></tr>
                <tr><td style="padding-left: 30px;">Fueling</td><td>‚Ç¶${monthlyFueling.toLocaleString()}</td><td>${revenue > 0 ? ((monthlyFueling/revenue)*100).toFixed(1) : 0}%</td></tr>
                <tr><td style="padding-left: 30px;">Electricity</td><td>‚Ç¶${monthlyElectricity.toLocaleString()}</td><td>${revenue > 0 ? ((monthlyElectricity/revenue)*100).toFixed(1) : 0}%</td></tr>
                <tr><td style="padding-left: 30px;">Charcoal</td><td>‚Ç¶${monthlyCharcoal.toLocaleString()}</td><td>${revenue > 0 ? ((monthlyCharcoal/revenue)*100).toFixed(1) : 0}%</td></tr>
                <tr><td style="padding-left: 30px;">Other Expenses</td><td>‚Ç¶${monthlyOther.toLocaleString()}</td><td>${revenue > 0 ? ((monthlyOther/revenue)*100).toFixed(1) : 0}%</td></tr>
                <tr><td style="padding-left: 30px;">Salaries & Wages</td><td>‚Ç¶${salaries.toLocaleString()}</td><td>${revenue > 0 ? ((salaries/revenue)*100).toFixed(1) : 0}%</td></tr>
                <tr style="background: #f5f5f5;"><td><strong>Total Operating Expenses</strong></td><td><strong>‚Ç¶${totalOperating.toLocaleString()}</strong></td><td><strong>${revenue > 0 ? ((totalOperating/revenue)*100).toFixed(1) : 0}%</strong></td></tr>
                <tr><td colspan="3"></td></tr>
                <tr style="background: ${grossProfit >= 0 ? '#e8f5e9' : '#ffebee'};"><td><strong>GROSS PROFIT</strong></td><td><strong>‚Ç¶${grossProfit.toLocaleString()}</strong></td><td><strong>${revenue > 0 ? ((grossProfit/revenue)*100).toFixed(1) : 0}%</strong></td></tr>
                <tr style="background: ${grossProfit >= 0 ? '#c8e6c9' : '#ffcdd2'};"><td><strong>NET PROFIT/LOSS</strong></td><td><strong>‚Ç¶${grossProfit.toLocaleString()}</strong></td><td><strong>${revenue > 0 ? ((grossProfit/revenue)*100).toFixed(1) : 0}%</strong></td></tr>
            `;
        }

        function generateMonthlyBalanceSheetTable(netProfit) {
            const tbody = document.getElementById('monthlyBalanceSheetBody');
            const birdsInStock = db.batches.reduce((sum, b) => sum + getCurrentBirds(b.id), 0);
            const livestockValue = birdsInStock * 2000;
            const feedStockValue = (db.feedStock['Super Starter'] + db.feedStock['Starter'] + db.feedStock['Finisher']) * 15000;
            const cashBalance = netProfit > 0 ? netProfit : 0;
            const totalAssets = cashBalance + livestockValue + feedStockValue;

            tbody.innerHTML = `
                <tr style="background: #e3f2fd;"><td colspan="2"><strong>ASSETS</strong></td><td colspan="2"><strong>LIABILITIES & EQUITY</strong></td></tr>
                <tr><td><strong>Current Assets</strong></td><td></td><td><strong>Current Liabilities</strong></td><td></td></tr>
                <tr><td style="padding-left: 30px;">Cash & Bank</td><td>‚Ç¶${cashBalance.toLocaleString()}</td><td style="padding-left: 30px;">Accounts Payable</td><td>‚Ç¶0</td></tr>
                <tr><td style="padding-left: 30px;">Livestock Inventory</td><td>‚Ç¶${livestockValue.toLocaleString()}</td><td style="padding-left: 30px;">Salaries Payable</td><td>‚Ç¶0</td></tr>
                <tr><td style="padding-left: 30px;">Feed Stock</td><td>‚Ç¶${feedStockValue.toLocaleString()}</td><td><strong>Total Liabilities</strong></td><td><strong>‚Ç¶0</strong></td></tr>
                <tr style="background: #f5f5f5;"><td><strong>Total Current Assets</strong></td><td><strong>‚Ç¶${totalAssets.toLocaleString()}</strong></td><td></td><td></td></tr>
                <tr><td></td><td></td><td><strong>Owner's Equity</strong></td><td></td></tr>
                <tr><td></td><td></td><td style="padding-left: 30px;">Opening Balance</td><td>‚Ç¶0</td></tr>
                <tr><td></td><td></td><td style="padding-left: 30px;">Add: Net Profit</td><td>‚Ç¶${netProfit.toLocaleString()}</td></tr>
                <tr style="background: #e8f5e9;"><td><strong>TOTAL ASSETS</strong></td><td><strong>‚Ç¶${totalAssets.toLocaleString()}</strong></td><td><strong>TOTAL LIABILITIES & EQUITY</strong></td><td><strong>‚Ç¶${totalAssets.toLocaleString()}</strong></td></tr>
            `;
        }

        function generateMonthlyExpenseBreakdown(expenses, totalOperating) {
            const tbody = document.getElementById('monthlyExpenseBreakdownBody');
            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No expenses recorded for this month</td></tr>';
                return;
            }

            let html = '';
            expenses.forEach(e => {
                const batch = db.batches.find(b => b.id === e.batchId);
                html += `<tr><td>${e.category}</td><td>${e.description || '-'}</td><td>${batch ? batch.name : 'General'}</td><td>‚Ç¶${e.amount.toLocaleString()}</td><td>${totalOperating > 0 ? ((e.amount/totalOperating)*100).toFixed(1) : 0}%</td></tr>`;
            });

            tbody.innerHTML = html;
        }

        function generateMonthlyFeedAnalysis(feeds, totalFeedCost) {
            const tbody = document.getElementById('monthlyFeedAnalysisBody');
            const byType = { 'Super Starter': 0, 'Starter': 0, 'Finisher': 0 };
            feeds.forEach(f => { if (byType[f.type] !== undefined) byType[f.type] += f.bagsConsumed; });

            let html = '';
            Object.keys(byType).forEach(type => {
                const bags = byType[type];
                const cost = bags * 15000;
                html += `<tr><td><span class="badge ${type === 'Super Starter' ? 'feed-super-starter' : type === 'Starter' ? 'feed-starter' : 'feed-finisher'}">${type}</span></td><td>${bags.toLocaleString()}</td><td>‚Ç¶15,000</td><td>‚Ç¶${cost.toLocaleString()}</td><td>${totalFeedCost > 0 ? ((cost/totalFeedCost)*100).toFixed(1) : 0}%</td></tr>`;
            });

            html += `<tr style="background: #f5f5f5;"><td><strong>TOTAL</strong></td><td><strong>${Object.values(byType).reduce((a, b) => a + b, 0).toLocaleString()}</strong></td><td></td><td><strong>‚Ç¶${totalFeedCost.toLocaleString()}</strong></td><td><strong>100%</strong></td></tr>`;
            tbody.innerHTML = html;
        }

        function generateMonthlySalesSummary(sales) {
            const tbody = document.getElementById('monthlySalesSummaryBody');
            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No sales recorded for this month</td></tr>';
                return;
            }

            let totalQty = 0, totalWeight = 0, totalAmount = 0;
            const html = sales.map(s => {
                const batch = db.batches.find(b => b.id === s.batchId);
                totalQty += s.quantity; totalWeight += s.weight; totalAmount += s.totalAmount;
                return `<tr><td>${formatDate(s.date)}</td><td>${batch ? batch.name : '-'}</td><td>${s.customer || '-'}</td><td>${s.quantity}</td><td>${s.weight}</td><td>‚Ç¶${s.totalAmount.toLocaleString()}</td></tr>`;
            }).join('');

            tbody.innerHTML = html + `<tr style="background: #e8f5e9;"><td colspan="3" style="text-align: right;"><strong>MONTHLY TOTAL:</strong></td><td><strong>${totalQty}</strong></td><td><strong>${totalWeight}</strong></td><td><strong>‚Ç¶${totalAmount.toLocaleString()}</strong></td></tr>`;
        }

        function exportMonthlyBalanceSheet() {
            const month = document.getElementById('balanceMonth').value;
            const year = document.getElementById('balanceYear').value;
            if (!month || !year) { alert('Please select a month and year'); return; }

            const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'long' });
            let csv = `TRIPLE A FARMS & FEEDS NIGERIA LTD\nMONTHLY BALANCE SHEET\nFor: ${monthName} ${year}\n\n`;

            const monthStart = `${year}-${month}-01`;
            const monthEnd = new Date(year, month, 0).toISOString().split('T')[0];
            const monthlySales = db.sales.filter(s => s.date >= monthStart && s.date <= monthEnd);
            const monthlyExpenses = db.expenses.filter(e => e.date >= monthStart && e.date <= monthEnd);
            const monthlySalaries = db.salaries.filter(s => s.date >= monthStart && s.date <= monthEnd);
            const monthlyFeeds = db.feeds.filter(f => f.date >= monthStart && f.date <= monthEnd);

            const totalRevenue = monthlySales.reduce((sum, s) => sum + s.totalAmount, 0);
            const totalExpenses = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalSalaries = monthlySalaries.reduce((sum, s) => sum + s.amount, 0);
            const totalFeedCost = monthlyFeeds.reduce((sum, f) => sum + f.bagsConsumed, 0) * 15000;
            const netProfit = totalRevenue - (totalExpenses + totalSalaries + totalFeedCost);

            csv += `INCOME STATEMENT\nDescription,Amount (‚Ç¶)\nSales Revenue,${totalRevenue}\nGeneral Expenses,${totalExpenses}\nSalaries & Wages,${totalSalaries}\nFeed Costs,${totalFeedCost}\nNET PROFIT,${netProfit}\n\n`;

            csv += `EXPENSES\nDate,Category,Description,Amount (‚Ç¶)\n`;
            monthlyExpenses.forEach(e => { csv += `"${e.date}","${e.category}","${e.description || ''}",${e.amount}\n`; });

            csv += `\nSALES\nDate,Customer,Quantity,Weight(kg),Amount (‚Ç¶)\n`;
            monthlySales.forEach(s => { csv += `"${s.date}","${s.customer || ''}",${s.quantity},${s.weight},${s.totalAmount}\n`; });

            downloadCSV(csv, `Monthly_Balance_Sheet_${monthName}_${year}.csv`);
        }

        function printMonthlyBalance() { window.print(); }

    </script>
</body>
</html>